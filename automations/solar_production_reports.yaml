#===============================================================================
# SOLAR PRODUCTION DAILY REPORTS
# File: automations/solar_production_reports.yaml
# Created: 2025-10-15
# Updated: 2025-10-16 - Fixed template formatting for email notifications
#===============================================================================

#-----------------------------------------------------------------------------
# DAILY SOLAR PRODUCTION REPORT - 22:00
#-----------------------------------------------------------------------------
- id: daily_solar_production_report
  alias: 'Solar: Daily Production Report at 22:00'
  description: 'Comprehensive daily solar production summary'
  
  trigger:
    - platform: time
      at: "22:00:00"
  
  condition: []
  
  action:
    - service: telegram_bot.send_message
      data:
#        target: !secret telegram_chat_id
        config_entry_id: 01K7PH2MD1SA9VXHCP39WVCJM4
        parse_mode: markdown
        message: >-
          â˜€ï¸ *DAILY SOLAR PRODUCTION REPORT*


          ðŸ“… {{ now().strftime('%A, %d %B %Y') }}


          *PV STRING PRODUCTION*

          ðŸ”† PV1: {{ states('sensor.deyeinvertermaster_summary_day_pv1') | float(0) | round(2) }} kWh

          ðŸ”† PV2: {{ states('sensor.deyeinvertermaster_summary_day_pv2') | float(0) | round(2) }} kWh

          âš¡ Total: {{ (states('sensor.deyeinvertermaster_summary_day_pv1') | float(0) + states('sensor.deyeinvertermaster_summary_day_pv2') | float(0)) | round(2) }} kWh


          *CUMULATIVE*

          ðŸ“Š PV1 Total: {{ states('sensor.deyeinvertermaster_summary_total_pv1_fix') | float(0) | round(1) }} kWh

          ðŸ“Š PV2 Total: {{ states('sensor.deyeinvertermaster_summary_total_pv2_fix') | float(0) | round(1) }} kWh


          *PERFORMANCE*

          ðŸŽ¯ Target: {{ states('input_number.solar_generation_target') | float(25) }} kWh

          ðŸ“Š Achievement: {{ ((states('sensor.deyeinvertermaster_summary_day_pv1') | float(0) + states('sensor.deyeinvertermaster_summary_day_pv2') | float(0)) / states('input_number.solar_generation_target') | float(25) * 100) | round(1) }}%


          ðŸŒ http://192.168.1.30:8123
    
    - service: notify.email_notification
      data:
        title: >-
          Daily Solar Production - {{ now().strftime('%Y-%m-%d') }}
        message: >-
          DAILY SOLAR PRODUCTION REPORT

          Date: {{ now().strftime('%A, %d %B %Y') }}


          PV1: {{ states('sensor.deyeinvertermaster_summary_day_pv1') | float(0) | round(2) }} kWh

          PV2: {{ states('sensor.deyeinvertermaster_summary_day_pv2') | float(0) | round(2) }} kWh

          Total: {{ (states('sensor.deyeinvertermaster_summary_day_pv1') | float(0) + states('sensor.deyeinvertermaster_summary_day_pv2') | float(0)) | round(2) }} kWh


          Target: {{ states('input_number.solar_generation_target') | float(25) }} kWh

          Achievement: {{ ((states('sensor.deyeinvertermaster_summary_day_pv1') | float(0) + states('sensor.deyeinvertermaster_summary_day_pv2') | float(0)) / states('input_number.solar_generation_target') | float(25) * 100) | round(1) }}%


          Battery Charged: {{ states('sensor.deyeinvertermaster_summary_day_battery_charge') | float(0) | round(2) }} kWh

          Grid Export: {{ states('sensor.deyeinvertermaster_summary_day_grid_export_sell') | float(0) | round(2) }} kWh


          System: http://192.168.1.30:8123
    
    - service: system_log.write
      data:
        message: >-
          Solar report sent. Total: {{ (states('sensor.deyeinvertermaster_summary_day_pv1') | float(0) + states('sensor.deyeinvertermaster_summary_day_pv2') | float(0)) | round(2) }} kWh
        level: info
  
  mode: single

#-----------------------------------------------------------------------------
# WEEKLY SUMMARY - MONDAYS 09:00
#-----------------------------------------------------------------------------
- id: weekly_solar_production_summary
  alias: 'Solar: Weekly Summary'
  description: 'Weekly solar production statistics'
  
  trigger:
    - platform: time
      at: "09:00:00"
  
  condition:
    - condition: time
      weekday:
        - mon
  
  action:
    - service: telegram_bot.send_message
      data:
#        target: !secret telegram_chat_id
        config_entry_id: 01K7PH2MD1SA9VXHCP39WVCJM4
        parse_mode: markdown
        message: >-
          ðŸ“Š *WEEKLY SOLAR SUMMARY*


          ðŸ“… {{ now().strftime('%d %B %Y') }}


          *PRODUCTION*

          â˜€ï¸ PV1: {{ states('sensor.deyeinvertermaster_summary_total_pv1_fix') | float(0) | round(1) }} kWh

          â˜€ï¸ PV2: {{ states('sensor.deyeinvertermaster_summary_total_pv2_fix') | float(0) | round(1) }} kWh

          âš¡ Total: {{ (states('sensor.deyeinvertermaster_summary_total_pv1_fix') | float(0) + states('sensor.deyeinvertermaster_summary_total_pv2_fix') | float(0)) | round(1) }} kWh


          *AVERAGE*

          ðŸ“ˆ Daily: {{ ((states('sensor.deyeinvertermaster_summary_total_pv1_fix') | float(0) + states('sensor.deyeinvertermaster_summary_total_pv2_fix') | float(0)) / 7) | round(2) }} kWh/day

          ðŸŽ¯ Target: {{ states('input_number.solar_generation_target') | float(25) }} kWh/day


          Have a great week!
    
        mode: single

#-----------------------------------------------------------------------------
# HIGH PRODUCTION DAY
#-----------------------------------------------------------------------------
- id: solar_high_production_celebration
  alias: 'Solar: High Production Day'
  description: 'Celebrate high production days'
  
  trigger:
    - platform: time
      at: "21:00:00"
  
  condition:
    - condition: template
      value_template: >-
        {% set total = states('sensor.deyeinvertermaster_summary_day_pv1') | float(0) + states('sensor.deyeinvertermaster_summary_day_pv2') | float(0) %}
        {% set target = states('input_number.solar_generation_target') | float(25) %}
        {{ total >= (target * 1.2) }}
  
  action:
    - service: telegram_bot.send_message
      data:
#        target: !secret telegram_chat_id
        config_entry_id: 01K7PH2MD1SA9VXHCP39WVCJM4
        parse_mode: markdown
        message: >-
          ðŸŽ‰ *EXCEPTIONAL SOLAR DAY!*


          ðŸ† Outstanding performance today!


          *PRODUCTION*

          â€¢ PV1: {{ states('sensor.deyeinvertermaster_summary_day_pv1') | float(0) | round(2) }} kWh

          â€¢ PV2: {{ states('sensor.deyeinvertermaster_summary_day_pv2') | float(0) | round(2) }} kWh

          â€¢ Total: {{ (states('sensor.deyeinvertermaster_summary_day_pv1') | float(0) + states('sensor.deyeinvertermaster_summary_day_pv2') | float(0)) | round(2) }} kWh


          *PERFORMANCE*

          â€¢ Target: {{ states('input_number.solar_generation_target') | float(25) }} kWh

          â€¢ Achievement: {{ ((states('sensor.deyeinvertermaster_summary_day_pv1') | float(0) + states('sensor.deyeinvertermaster_summary_day_pv2') | float(0)) / states('input_number.solar_generation_target') | float(25) * 100) | round(1) }}%


          Keep it up!
    
        mode: single

#-----------------------------------------------------------------------------
# LOW PRODUCTION ALERT
#-----------------------------------------------------------------------------
- id: solar_low_production_alert
  alias: 'Solar: Low Production Alert'
  description: 'Alert on low production days'
  
  trigger:
    - platform: time
      at: "20:00:00"
  
  condition:
    - condition: template
      value_template: >-
        {% set total = states('sensor.deyeinvertermaster_summary_day_pv1') | float(0) + states('sensor.deyeinvertermaster_summary_day_pv2') | float(0) %}
        {% set target = states('input_number.solar_generation_target') | float(25) %}
        {{ total < (target * 0.5) }}
  
  action:
    - service: telegram_bot.send_message
      data:
#        target: !secret telegram_chat_id
        config_entry_id: 01K7PH2MD1SA9VXHCP39WVCJM4
        parse_mode: markdown
        message: >-
          âš ï¸ *LOW SOLAR PRODUCTION*


          Production below normal today.


          *TODAY*

          â€¢ PV1: {{ states('sensor.deyeinvertermaster_summary_day_pv1') | float(0) | round(2) }} kWh

          â€¢ PV2: {{ states('sensor.deyeinvertermaster_summary_day_pv2') | float(0) | round(2) }} kWh

          â€¢ Total: {{ (states('sensor.deyeinvertermaster_summary_day_pv1') | float(0) + states('sensor.deyeinvertermaster_summary_day_pv2') | float(0)) | round(2) }} kWh


          *EXPECTED*

          â€¢ Target: {{ states('input_number.solar_generation_target') | float(25) }} kWh

          â€¢ Achieved: {{ ((states('sensor.deyeinvertermaster_summary_day_pv1') | float(0) + states('sensor.deyeinvertermaster_summary_day_pv2') | float(0)) / states('input_number.solar_generation_target') | float(25) * 100) | round(1) }}%


          *WEATHER*

          Cloud Coverage: {{ states('sensor.cloud_coverage') }}%


          Check system tomorrow.
    
        mode: single

#-----------------------------------------------------------------------------
# STRING IMBALANCE
#-----------------------------------------------------------------------------
- id: solar_pv_string_imbalance
  alias: 'Solar: String Imbalance'
  description: 'Alert on PV string imbalance'
  
  trigger:
    - platform: time
      at: "19:00:00"
  
  condition:
    - condition: template
      value_template: >-
        {% set pv1 = states('sensor.deyeinvertermaster_summary_day_pv1') | float(0) %}
        {% set pv2 = states('sensor.deyeinvertermaster_summary_day_pv2') | float(0) %}
        {% set avg = (pv1 + pv2) / 2 %}
        {% set diff = (pv1 - pv2) | abs %}
        {{ (diff / avg * 100) > 20 and pv1 > 1 and pv2 > 1 }}
  
  action:
    - service: telegram_bot.send_message
      data:
#        target: !secret telegram_chat_id
        config_entry_id: 01K7PH2MD1SA9VXHCP39WVCJM4
        parse_mode: markdown
        message: >-
          âš ï¸ *PV STRING IMBALANCE*


          String production difference detected.


          *STRINGS*

          ðŸ”† PV1: {{ states('sensor.deyeinvertermaster_summary_day_pv1') | float(0) | round(2) }} kWh

          ðŸ”† PV2: {{ states('sensor.deyeinvertermaster_summary_day_pv2') | float(0) | round(2) }} kWh


          *DIFFERENCE*

          {{ (states('sensor.deyeinvertermaster_summary_day_pv1') | float(0) - states('sensor.deyeinvertermaster_summary_day_pv2') | float(0)) | abs | round(2) }} kWh


          *CHECK FOR*

          1. Shading on one string

          2. Panel soiling

          3. Connection issues


          Monitor for several days.
    
        mode: single

#-----------------------------------------------------------------------------
# MONTHLY SUMMARY
#-----------------------------------------------------------------------------
- id: solar_monthly_summary
  alias: 'Solar: Monthly Summary'
  description: 'Monthly production report'
  
  trigger:
    - platform: time
      at: "10:00:00"
  
  condition:
    - condition: template
      value_template: "{{ now().day == 1 }}"
  
  action:
    - service: telegram_bot.send_message
      data:
#        target: !secret telegram_chat_id
        config_entry_id: 01K7PH2MD1SA9VXHCP39WVCJM4
        parse_mode: markdown
        message: >-
          ðŸ“Š *MONTHLY SOLAR REPORT*


          ðŸ“… {{ now().strftime('%B %Y') }}


          *TOTAL*

          â˜€ï¸ Generated: {{ (states('sensor.deyeinvertermaster_summary_total_pv1_fix') | float(0) + states('sensor.deyeinvertermaster_summary_total_pv2_fix') | float(0)) | round(1) }} kWh

          â€¢ PV1: {{ states('sensor.deyeinvertermaster_summary_total_pv1_fix') | float(0) | round(1) }} kWh

          â€¢ PV2: {{ states('sensor.deyeinvertermaster_summary_total_pv2_fix') | float(0) | round(1) }} kWh


          *AVERAGE*

          ðŸ“ˆ Daily: {{ ((states('sensor.deyeinvertermaster_summary_total_pv1_fix') | float(0) + states('sensor.deyeinvertermaster_summary_total_pv2_fix') | float(0)) / 30) | round(2) }} kWh/day

          ðŸŽ¯ Target: {{ states('input_number.solar_generation_target') | float(25) }} kWh/day


          *VALUE*

          ðŸ’° ZAR {{ ((states('sensor.deyeinvertermaster_summary_total_pv1_fix') | float(0) + states('sensor.deyeinvertermaster_summary_total_pv2_fix') | float(0)) * 2.50) | round(2) }}


          Great month!
    
    - service: notify.email_notification
      data:
        title: >-
          Monthly Solar Report - {{ now().strftime('%B %Y') }}
        message: >-
          MONTHLY SOLAR PRODUCTION REPORT

          Month: {{ now().strftime('%B %Y') }}


          Total Generated: {{ (states('sensor.deyeinvertermaster_summary_total_pv1_fix') | float(0) + states('sensor.deyeinvertermaster_summary_total_pv2_fix') | float(0)) | round(1) }} kWh

          PV1: {{ states('sensor.deyeinvertermaster_summary_total_pv1_fix') | float(0) | round(1) }} kWh

          PV2: {{ states('sensor.deyeinvertermaster_summary_total_pv2_fix') | float(0) | round(1) }} kWh


          Daily Average: {{ ((states('sensor.deyeinvertermaster_summary_total_pv1_fix') | float(0) + states('sensor.deyeinvertermaster_summary_total_pv2_fix') | float(0)) / 30) | round(2) }} kWh/day

          Target: {{ states('input_number.solar_generation_target') | float(25) }} kWh/day


          Financial Value: ZAR {{ ((states('sensor.deyeinvertermaster_summary_total_pv1_fix') | float(0) + states('sensor.deyeinvertermaster_summary_total_pv2_fix') | float(0)) * 2.50) | round(2) }}


          System: http://192.168.1.30:8123
    
        mode: single

#===============================================================================
# END OF SOLAR PRODUCTION REPORTS
#===============================================================================