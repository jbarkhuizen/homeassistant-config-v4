#===============================================================================
# Daily Sensor Report Automation - Single Optimized Version (Corrected)
# File: automations_sensor_extract.yaml  
# Updated: 2025-09-12
# Purpose: Single comprehensive daily report at 09:00
#===============================================================================

- id: comprehensive_daily_report_optimized
  alias: "Daily System Report - Comprehensive (09:00)"
  description: "Single optimized daily report covering all system aspects"
  trigger:
    - platform: time
      at: "09:00:00"
  condition: []
  action:
    # Step 1: Update all system metrics first
    - service: homeassistant.update_entity
      target:
        entity_id:
          - sensor.active_automations_count
          - sensor.disabled_automations_count
          - sensor.system_uptime_days
    
    # Step 2: Generate sensor report
    - service: shell_command.extract_sensors
      data: {}
    
    # Step 3: Wait for report generation to complete
    - delay:
        seconds: 60
    
    # Step 4: Send single comprehensive email
    - service: notify.email_ha
      data:
        title: "ğŸ  Daily Smart Home Report - {{ now().strftime('%A, %B %d, %Y') }}"
        message: |
          SMART HOME DAILY REPORT
          Generated: {{ now().strftime('%Y-%m-%d at %H:%M:%S') }}
          Location: Pierre van Ryneveld, Gauteng (192.168.1.30:8123)
          
          âš¡ ENERGY SYSTEM STATUS:
          â€¢ Master Battery SOC: {{ states('sensor.deyeinvertermaster_summary_battery_soc') | default('N/A') }}%
          â€¢ Slave Battery SOC: {{ states('sensor.deyeinverterslave_summary_battery_soc') | default('N/A') }}%
          â€¢ Daily Solar Generation: {{ states('sensor.deyeinvertermaster_summary_day_pv_generation') | default('N/A') }} kWh
          â€¢ Grid Status: {{ 'Online' if states('sensor.deyeinvertermaster_summary_battery_soc') not in ['unknown', 'unavailable'] else 'Check Required' }}
          
          ğŸ¤– AUTOMATION SYSTEM:
          â€¢ Active Automations: {{ states('sensor.active_automations_count') | default('N/A') }}
          â€¢ Disabled Automations: {{ states('sensor.disabled_automations_count') | default('N/A') }}
          â€¢ System Uptime: {{ states('sensor.system_uptime_days') | default('N/A') }} days
          â€¢ System Health: {{ 'Optimal' if states('sensor.active_automations_count') | int(0) > 0 else 'Check Required' }}
          
          ğŸ’¾ SYSTEM PERFORMANCE:
          â€¢ CPU Usage: {{ states('sensor.processor_use') | default('N/A') }}%
          â€¢ Memory Usage: {{ states('sensor.memory_use_percent') | default('N/A') }}%
          â€¢ Database Size: {{ states('sensor.database_size') | default('N/A') }}MB
          
          ğŸ”— INTEGRATION STATUS:
          â€¢ SONOFF Devices: Connected
          â€¢ TUYA Devices: Connected
          â€¢ OneDrive: {{ states('sensor.onedrive_drive_state') | default('N/A') | title }}
          â€¢ InfluxDB: Recording
          â€¢ Telegram: âœ… Active
          â€¢ Email Services: âœ… Operational
          
          ğŸ“Š SENSOR REPORTS:
          â€¢ Report Files: âœ… Generated (/config/sensor_reports/)
          â€¢ CSV Export: sensors_report_{{ now().strftime('%Y%m%d_090000') }}.csv
          â€¢ JSON Export: sensors_report_{{ now().strftime('%Y%m%d_090000') }}.json
          â€¢ Summary: sensors_summary_{{ now().strftime('%Y%m%d_090000') }}.md
          
          âš™ï¸ RECOMMENDED ACTIONS:
          {% if states('sensor.deyeinvertermaster_summary_battery_soc') | float(100) < 30 %}
          â€¢ âš ï¸ Monitor battery levels - Master at {{ states('sensor.deyeinvertermaster_summary_battery_soc') }}%
          {% endif %}
          {% if states('sensor.processor_use') | float(0) > 70 %}
          â€¢ ğŸ–¥ï¸ Check system performance - CPU usage at {{ states('sensor.processor_use') }}%
          {% endif %}
          {% if states('sensor.system_uptime_days') | int(0) > 30 %}
          â€¢ ğŸ”„ Consider planned system restart - uptime {{ states('sensor.system_uptime_days') }} days
          {% endif %}
          
          ğŸ”— Quick Access:
          â€¢ Dashboard: http://192.168.1.30:8123
          â€¢ File Editor: /config/sensor_reports/
          
          Next report: {{ (now() + timedelta(days=1)).strftime('%Y-%m-%d at 09:00') }}
          
          Best regards,
          Home Assistant Automation System
    
    # Step 5: Send Telegram confirmation (CORRECTED SERVICE)
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_id
        title: "ğŸ“Š Daily Report Sent"
        message: |
          Daily system report completed at {{ now().strftime('%H:%M:%S') }}
          
          ğŸ“§ Email sent successfully
          ğŸ“ Reports saved to /config/sensor_reports/
          âœ… All systems operational