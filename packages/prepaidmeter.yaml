# ==============================================================================
# Added the Prepaid Meter Config from 
# https://github.com/tomatensaus/DeyeSolarDesktop/blob/main/packages/prepaidmeter.yaml
# on 6 Oct 2025 @ 18h27
# ==============================================================================
template:
  - sensor:
      - name: "Prepaid units left"
        unit_of_measurement: "kWh"
        state: >
          {% set units = states('input_number.prepaid_meter_units') | float(1) %}
          {% set currentTotal = (states('sensor.deyeinvertermaster_summary_total_grid_import_buy') | float(6)) * 1000.0 %}
          {% set totalWhenRecharged = states('input_number.prepaid_meter_inverter_total_units') | float(2)  %}
          {% set totalUsed = currentTotal - totalWhenRecharged  %}
          {{ (units - totalUsed ) | round(2)}}

input_number:
  prepaid_meter_units:
    name: Prepaid meter Recharge Units
    min: 0.01
    max: 10000.01
    step: 1
    mode: box

  prepaid_meter_inverter_total_units:
    name: Prepaid meter Inverter Reading
    min: 0.01
    max: 1000000.01
    mode: box
# ==============================================================================
# Added by Claude.ai on 14 Oct 2025 to enable Prepaid Thresholds
# Prepaid Meter Alert Thresholds
# ==============================================================================
  prepaid_meter_warning_threshold:
    name: Prepaid Meter Warning Level
    min: 10
    max: 200
    step: 5
    initial: 50
    unit_of_measurement: "kWh"
    icon: mdi:alert-circle
    mode: box

  prepaid_meter_critical_threshold:
    name: Prepaid Meter Critical Level
    min: 5
    max: 100
    step: 5
    initial: 20
    unit_of_measurement: "kWh"
    icon: mdi:alert
    mode: box

  prepaid_meter_emergency_threshold:
    name: Prepaid Meter Emergency Level
    min: 1
    max: 50
    step: 1
    initial: 5
    unit_of_measurement: "kWh"
    icon: mdi:alert-octagon
    mode: box

# Input Boolean for Emergency Mode
input_boolean:
  prepaid_meter_emergency_mode:
    name: Prepaid Meter Emergency Mode
    icon: mdi:flash-alert
# ==============================================================================